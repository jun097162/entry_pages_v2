<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>フロー1：基礎情報</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 14px;
    line-height: 1.5;
    color: #333;
    background-color: #f8f9fa;
    padding: 20px;
}
.container {
    max-width: 900px;
    margin: 0 auto;
    background-color: #fff;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 4px;
}
h1, h2 {
    color: #333;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 20px;
}
h2 {
    font-size: 1.2em;
    margin-top: 30px;
}
h3 {
    font-size: 1.1em;
    margin-top: 20px;
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 1px dotted #ccc;
}
h4 { /* Added for sub-sections like 利用交通機関詳細 */
    font-size: 1.05em;
    margin-top: 15px;
    margin-bottom: 10px;
    color: #555;
}
.form-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}
.form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}
.form-group {
    margin-bottom: 15px;
    position: relative; /* For suggestion box positioning */
}
.form-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
}
.form-group input[type="text"],
.form-group input[type="tel"],
.form-group input[type="email"],
.form-group input[type="date"],
.form-group input[type="number"],
.form-group input[type="file"],
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
}
.form-group input[type="file"] {
    padding: 3px 8px;
}
textarea {
    min-height: 80px;
    resize: vertical;
}
.inline-fields {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.inline-fields .form-group {
    flex: 1;
    min-width: 200px;
}
.postal-code-group {
    display: flex;
    align-items: flex-end;
    gap: 10px;
}
.postal-code-group .form-group {
    flex-grow: 1;
}
.postal-code-group button {
    padding: 8px 12px;
    font-size: 0.9em;
    height: 35px;
    flex-shrink: 0;
    margin-bottom: 15px;
}
.radio-group label,
.checkbox-group label {
    font-weight: normal;
    margin-right: 15px;
}
.radio-group input[type="radio"],
.checkbox-group input[type="checkbox"] {
    margin-right: 5px;
    vertical-align: middle;
}
.readonly-field {
    background-color: #e9ecef;
    cursor: not-allowed;
}
.required-field {
    border: 1px solid red;
    background-color: #fff0f0;
}
.description, .note, .file-status {
    font-size: 0.9em;
    color: #666;
    margin-top: 5px;
}
.annotation {
     /* ... existing styles ... */
}
.document-box {
    border: 1px dashed #ccc;
    padding: 15px;
    text-align: center;
    margin: 10px 0;
    background-color: #f9f9f9;
    flex: 1;
    min-width: 200px;
    position: relative;
}
.document-box.clickable-document {
    cursor: pointer;
    transition: background-color 0.2s;
}
.document-box.clickable-document:hover {
    background-color: #f0f0f0;
}
.document-box p {
    margin: 5px 0;
}
.document-icon {
    font-size: 2em;
    color: #007bff;
}
.upload-button-placeholder, .action-button-style {
    display: inline-block;
    padding: 8px 12px;
    background-color: #007bff;
    color: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    border: none;
    text-align: center;
}
.upload-button-placeholder:hover, .action-button-style:hover {
    background-color: #0056b3;
}
.modal-trigger-link {
    color: #007bff;
    text-decoration: underline;
    cursor: pointer;
}
.conditions {
    border: 1px solid #007bff;
    padding: 15px;
    margin-top: 10px;
    background-color: #e7f3ff;
    border-radius: 4px;
}
.conditions ul {
    padding-left: 20px;
    margin: 0;
}
.conditions li {
    margin-bottom: 5px;
}
.checkbox-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
}
.checkbox-list .checkbox-group {
    display: flex;
    align-items: center;
}
.checkbox-list .checkbox-group .upload-icon-placeholder {
    margin-left: auto;
    font-size: 0.8em;
    color: #007bff;
    cursor: pointer;
}

/* Suggestion Box Styles */
.suggestion-box {
    display: none;
    position: absolute;
    background-color: white;
    border: 1px solid #ccc;
    border-top: none;
    z-index: 100;
    width: calc(100% - 2px);
    max-height: 150px;
    overflow-y: auto;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    box-sizing: border-box;
    left: 0;
    top: 100%;
}
.suggestion-box div {
    padding: 8px;
    cursor: pointer;
}
.suggestion-box div:hover {
    background-color: #f0f0f0;
}
.file-upload-status-container {
    margin-top: 5px;
    display: flex;
    align-items: center;
    justify-content: center; /* Center items if they wrap */
    gap: 5px;
}
.delete-file-btn {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 3px 7px;
    font-size: 0.8em;
    border-radius: 3px;
    cursor: pointer;
    line-height: 1; /* Ensure consistent height */
}
.delete-file-btn:hover {
    background-color: #c82333;
}


/* Modal Styles (Shared) */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
    align-items: center; 
    justify-content: center;
}
.modal-content {
    background-color: #fefefe;
    margin: auto; 
    padding: 25px; 
    border: 1px solid #888;
    width: 80%;
    max-width: 600px; 
    border-radius: 8px;
    position: relative;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

/* General styles for modal header, applicable to all modals using this structure */
.modal-header {
    padding-bottom: 15px;
    border-bottom: 1px solid #e9ecef;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.4em; 
    color: #333;
    border-bottom: none;
}

/* General modal close button style */
.modal .close-button { 
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1; 
    padding: 0 5px; 
}
.modal .close-button:hover,
.modal .close-button:focus {
    color: black;
    text-decoration: none;
}

/* Contract Agreement Modal Specific Styles */
.contract-agreement-modal .modal-content { /* Specific overrides for contract modals */
    padding: 25px 30px; 
    max-width: 900px; 
}
.contract-agreement-modal .modal-body .form-group { margin-bottom: 20px; }
.contract-agreement-modal .modal-body label { display: block; font-size: 14px; font-weight: bold; color: #333; margin-bottom: 8px; }
.contract-agreement-modal .modal-body input[type="text"],
.contract-agreement-modal .modal-body textarea { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
.contract-agreement-modal .modal-body textarea { min-height: 100px; resize: vertical; }
.contract-agreement-modal .modal-body .required-label { background-color: #fd7e14; color: white; padding: 2px 6px; font-size: 10px; border-radius: 3px; margin-left: 5px; }
.contract-agreement-modal .modal-footer { padding-top: 20px; border-top: 1px solid #e9ecef; margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
.contract-agreement-modal .modal-footer .btn-secondary { background-color: #f8f9fa; color: #333; border: 1px solid #ced4da; }
.contract-agreement-modal .error-message { display: block; color: #dc3545; font-size: 12px; margin-top: 4px; }
.contract-agreement-modal .input-error { border-color: #dc3545 !important; }
.contract-agreement-modal .agree-modal-body .checkbox-group { margin-bottom: 15px; display: flex; align-items: center; }
.contract-agreement-modal .agree-modal-body input[type="checkbox"] { margin-right: 10px; transform: scale(1.1); }

.contract-viewer {
    border: 1px solid #ccc; border-radius: 6px; padding: 10px; margin-bottom: 15px;
    background-color: #fff; overflow-x: auto; max-height: 400px; overflow-y: auto;
}
.contract-viewer img { max-width: 100%; height: auto; display: block; margin: 0 auto; }
.action-prompt {  text-align: center; font-size: 14px; color: #555; margin-bottom: 15px; }
.button-group {  display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; }
.action-btn {
    padding: 10px 25px; font-size: 15px; border: none; border-radius: 5px;
    cursor: pointer; font-weight: bold; transition: background-color 0.3s, box-shadow 0.3s;
}
.agree-btn { background-color: #007bff; color: white; }
.reject-btn { background-color: #f8f9fa; color: #dc3545; border: 1px solid #dc3545; }
.reject-btn.submit { background-color: #dc3545; color: white; }

.post-agreement-actions-modal {
    display: none; flex-direction: column; align-items: center; gap: 10px; margin-top: 15px;
}
.action-buttons-row-inner { display: flex; justify-content: center; gap: 10px; }
.action-btn-small {
    padding: 8px 15px; font-size: 14px; border: 1px solid #ccc; background-color: #fff;
    color: #333; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;
}
.action-btn-small svg { width: 1em; height: 1em; fill: currentColor; }
.post-agreement-actions-modal .checkbox-option { display: flex; align-items: center; font-size: 14px; }
.post-agreement-actions-modal .checkbox-option input[type="checkbox"] { margin-right: 5px; }
.document-box-post-actions { margin-top: 10px; display: flex; justify-content: center; gap: 10px; }
.image-preview-container { display: flex; align-items: flex-start; gap: 20px; }
.image-preview-container .form-group { flex: 1; }
.image-preview-box {
    width: 200px; height: 150px; border: 2px dashed #ccc; display: flex;
    justify-content: center; align-items: center; text-align: center;
    color: #777; background-color: #f9f9f9; overflow: hidden;
}
.image-preview-box img { max-width: 100%; max-height: 100%; display: block; }
.commute-method-specific-section {
    border: 1px solid #e0e0e0; padding: 15px; margin-top: 15px;
    border-radius: 4px; background-color: #fdfdfd;
}
.contract-status { font-weight: bold; }
.status-agreed { color: green; }
.status-pending { color: orange; }
.status-rejected { color: red; }

.work-history-entry {
    border: 1px solid #e0e0e0; padding: 15px; margin-bottom: 15px;
    border-radius: 4px; background-color: #fdfdfd;
}
.work-history-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
}
.work-history-header h3 { margin-top: 0; margin-bottom: 0; border-bottom: none; }
.delete-work-history-btn {
    background-color: #dc3545; color: white; border: none; padding: 5px 10px;
    border-radius: 4px; font-size: 0.85em; cursor: pointer;
}
.delete-work-history-btn:hover { background-color: #c82333; }

.debug-controls {
    background-color: #f0f0f0;
    padding: 10px;
    margin-bottom: 20px;
    text-align: center;
    border: 1px solid #ddd;
    border-radius: 4px;
}
.debug-controls button {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    margin: 0 5px;
}
.debug-controls button:hover {
    background-color: #5a6268;
}
.navigation-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
}
.navigation-buttons .action-button-style {
    padding: 10px 20px;
    font-size: 1.1em;
}
.navigation-buttons .next-btn {
    background-color: #007bff;
}
.navigation-buttons .prev-btn {
    background-color: #6c757d;
}
.navigation-buttons .submit-btn {
    background-color: #28a745;
}
        /* ページタイトルスタイルを統一 */
        h1 {
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            color: #0056b3;
            font-size: 1.8em;
            margin-bottom: 1.5rem;
        }
        .file-upload-area {
            border: 2px dashed #ccc;
            border-radius: 6px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
        }
        .file-upload-area.dragover {
            border-color: #007bff;
            background-color: #f0f8ff;
        }
        .file-upload-area p { margin: 0; color: #555; }
        .file-upload-area .browse-link { color: #007bff; text-decoration: underline; }
        #file-info { margin-top: 1rem; font-size: 0.9rem; }
        .file-info-header, .file-info-row { display: flex; justify-content: space-between; padding: 0.5rem 0; }
        .file-info-header { font-weight: bold; border-bottom: 1px solid #eee; }
        .file-info-header .file-name, .file-info-row .file-name { flex-basis: 70%; }
        .file-info-header .file-size, .file-info-row .file-size { flex-basis: 30%; }
        #bank_account_file_input { display: none; }

        /* ▼▼▼ ゆうちょ銀行フォーム用の追加スタイル ▼▼▼ */
        .jp-bank-account-number-fields {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .jp-bank-account-number-fields .form-group {
            flex: 1 1 auto;
        }
        .jp-bank-account-number-fields span {
            font-size: 1.5em;
            color: #6c757d;
        }
        #jp_kigo_1 { flex-basis: 150px; }
        #jp_kigo_2 { flex-basis: 80px; }
        #jp_bango { flex-basis: 200px; }
        /* ▲▲▲ 追加スタイルここまで ▲▲▲ */
    </style>
</head>
<body>
    <div class="container">
        <h1>フロー1：基礎情報</h1>
        <div class="debug-controls">
            <button id="dev_fill_form_btn">テストデータ入力</button>
            <button id="dev_reset_form_btn">フォーム入力リセット</button>
            <button id="dev_clear_storage_btn">LocalStorageクリア</button>
        </div>

        <form action="#" method="post" id="onboardingFormPage1">
            <!-- 基本情報 -->
            <fieldset class="form-section">
                <legend><h2>基本情報</h2></legend>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="last_name">姓</label>
                        <input type="text" id="last_name" name="last_name" value="山田">
                    </div>
                    <div class="form-group">
                        <label for="first_name">名</label>
                        <input type="text" id="first_name" name="first_name" value="太郎">
                    </div>
                    <div class="form-group">
                        <label for="last_name_kana">姓（ヨミガナ）</label>
                        <input type="text" id="last_name_kana" name="last_name_kana" value="ヤマダ">
                    </div>
                    <div class="form-group">
                        <label for="first_name_kana">名（ヨミガナ）</label>
                        <input type="text" id="first_name_kana" name="first_name_kana" value="タロウ">
                    </div>
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="gender">性別</label>
                        <select id="gender" name="gender">
                            <option value="">選択してください</option>
                            <option value="male" selected>男性</option>
                            <option value="female">女性</option>
                            <option value="other">その他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birth_date">生年月日</label>
                        <input type="date" id="birth_date" name="birth_date" value="1990-01-01">
                    </div>
                </div>
                <div class="form-group">
                    <label for="department">所属事業所名（編集不可）</label>
                    <input type="text" id="department" name="department" value="ONOKICHI事業所" readonly class="readonly-field">
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="phone_number">電話番号</label>
                        <input type="tel" id="phone_number" name="phone_number" placeholder="例:03-0000-0000" value="03-1234-5678">
                        <p class="description">半角入力 (例)03-0000-0000</p>
                    </div>
                    <div class="form-group">
                        <label for="mobile_phone_number">携帯電話番号</label>
                        <input type="tel" id="mobile_phone_number" name="mobile_phone_number" class="required-field" placeholder="例:080-0000-0000">
                        <p class="description">半角入力 (例)080-0000-0000</p>
                    </div>
                </div>
                <div class="form-group">
                    <label for="email">個人メールアドレス</label>
                    <input type="email" id="email" name="email" class="required-field">
                    <p class="description">このメールアドレスはログイン時に必要となります。</p>
                </div>
                <div class="form-group">
                    <label>国籍</label>
                    <div class="radio-group">
                        <label><input type="radio" name="nationality" value="japanese" checked> 日本人</label>
                        <label><input type="radio" name="nationality" value="foreign"> 外国籍</label>
                    </div>
                </div>
                <div class="form-group" id="residence_status_group" style="display:none;"> <!-- JSで表示制御 -->
                    <label for="residence_status">滞在区分</label>
                    <select id="residence_status" name="residence_status">
                        <option value="">選択してください</option>
                        <option value="student">留学生</option>
                        <option value="family_stay">家族滞在</option>
                        <option value="specified_activities">特定活動</option>
                        <option value="other_permanent_resident">上記以外(外国籍永住者等)</option>
                    </select>
                </div>
            </fieldset>

            <!-- 契約書類 -->
            <fieldset class="form-section" id="contract_documents_section">
                <legend><h2>契約書類</h2></legend>
                <div class="inline-fields">
                    <div class="document-box clickable-document" data-modal-target="#employmentContractModal" data-contract-id="employmentContract" data-contract-name="雇用契約書 兼 雇入通知書">
                        <span class="document-icon">📄</span>
                        <p>(入社)雇用契約書 兼<br>雇入通知書</p>
                        <p class="contract-status status-pending" id="employmentContractStatus">（未合意）</p>
                        <div class="document-box-post-actions" id="employmentContractPostActions" style="display:none;">
                            <button type="button" class="action-btn-small print-contract-btn">
                                <svg viewBox="0 0 20 20"><path d="M16 10c0 .55-.45 1-1 1H5c-.55 0-1-.45-1-1s.45-1 1-1h10c.55 0 1 .45 1 1zM5 13h4c.55 0 1 .45 1 1s-.45 1-1 1H5c-.55 0-1-.45-1-1s.45-1 1-1zm12-8H3c-.55 0-1 .45-1 1v2H1c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1h18c.55 0 1-.45 1-1V6c0-.55-.45-1-1-1zm-1 10H2V7h1V4h14v9zM6 2h8v2H6V2z"/></svg>
                                印刷
                            </button>
                            <button type="button" class="action-btn-small download-contract-btn">
                                <svg viewBox="0 0 20 20"><path d="M13 8V2H7v6H2l8 8 8-8h-5zM0 18h20v2H0v-2z"/></svg>
                                ダウンロード
                            </button>
                        </div>
                    </div>
                    <div class="document-box clickable-document" data-modal-target="#guaranteeContractModal" data-contract-id="guaranteeContract" data-contract-name="契約書 兼 身元保証書">
                        <span class="document-icon">📄</span>
                        <p>契約書 兼 身元保証書</p>
                         <p class="contract-status status-pending" id="guaranteeContractStatus">（未合意）</p>
                         <div class="document-box-post-actions" id="guaranteeContractPostActions" style="display:none;">
                            <button type="button" class="action-btn-small print-contract-btn">
                                <svg viewBox="0 0 20 20"><path d="M16 10c0 .55-.45 1-1 1H5c-.55 0-1-.45-1-1s.45-1 1-1h10c.55 0 1 .45 1 1zM5 13h4c.55 0 1 .45 1 1s-.45 1-1 1H5c-.55 0-1-.45-1-1s.45-1 1-1zm12-8H3c-.55 0-1 .45-1 1v2H1c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1h18c.55 0 1-.45 1-1V6c0-.55-.45-1-1-1zm-1 10H2V7h1V4h14v9zM6 2h8v2H6V2z"/></svg>
                                印刷
                            </button>
                            <button type="button" class="action-btn-small download-contract-btn">
                                <svg viewBox="0 0 20 20"><path d="M13 8V2H7v6H2l8 8 8-8h-5zM0 18h20v2H0v-2z"/></svg>
                                ダウンロード
                            </button>
                        </div>
                    </div>
                </div>
                <!-- 外国籍の場合の追加書類用コンテナ -->
                <div id="foreign_documents_container" class="inline-fields" style="display:none; margin-top:15px; gap: 10px; flex-wrap: wrap;">
                    <!-- JSでここに在留カードとパスポートの項目を追加 -->
                </div>
            </fieldset>

            <!-- 現住所 -->
            <fieldset class="form-section">
                <legend><h2>現住所</h2></legend>
                <div class="postal-code-group">
                    <div class="form-group">
                        <label for="postal_code">住所(郵便番号)</label>
                        <input type="text" id="postal_code" name="postal_code" placeholder="例:1000001 または 100-0001" maxlength="8">
                    </div>
                    <button type="button" class="action-button-style" id="search_address_btn">住所検索</button>
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="prefecture">住所(都道府県)</label>
                        <input type="text" id="prefecture" name="prefecture" placeholder="例:東京都">
                    </div>
                     <div class="form-group">
                        <label for="city">住所(市区町村)</label>
                        <input type="text" id="city" name="city" placeholder="例:千代田区千代田">
                    </div>
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="address_line1">住所(丁目・番地)</label>
                        <input type="text" id="address_line1" name="address_line1" placeholder="例:1-1">
                    </div>
                    <div class="form-group">
                        <label for="address_line2">住所(建物名・部屋番号)</label>
                        <input type="text" id="address_line2" name="address_line2" placeholder="例:〇〇ビル101号室">
                    </div>
                </div>
                 <div class="form-group">
                    <label for="address_kana">住所(ヨミガナ)</label>
                    <input type="text" id="address_kana" name="address_kana" placeholder="例:トウキョウトチヨダクチヨダ">
                </div>
            </fieldset>

            <!-- 緊急連絡先 -->
            <fieldset class="form-section">
                <legend><h2>緊急連絡先</h2></legend>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="emergency_last_name">(姓)</label>
                        <input type="text" id="emergency_last_name" name="emergency_last_name" placeholder="例: 鈴木">
                    </div>
                    <div class="form-group">
                        <label for="emergency_first_name">(名)</label>
                        <input type="text" id="emergency_first_name" name="emergency_first_name" placeholder="例: 花子">
                    </div>
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="emergency_last_name_kana">(姓:ヨミガナ)</label>
                        <input type="text" id="emergency_last_name_kana" name="emergency_last_name_kana" placeholder="例: スズキ">
                    </div>
                    <div class="form-group">
                        <label for="emergency_first_name_kana">(名:ヨミガナ)</label>
                        <input type="text" id="emergency_first_name_kana" name="emergency_first_name_kana" placeholder="例: ハナコ">
                    </div>
                </div>
                <div class="postal-code-group">
                    <div class="form-group">
                        <label for="emergency_postal_code">住所(郵便番号)</label>
                        <input type="text" id="emergency_postal_code" name="emergency_postal_code" placeholder="例: 1000002 または 100-0002" maxlength="8">
                    </div>
                    <button type="button" class="action-button-style" id="search_emergency_address_btn">住所検索</button>
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="emergency_prefecture">住所(都道府県)</label>
                        <input type="text" id="emergency_prefecture" name="emergency_prefecture" placeholder="例: 東京都">
                    </div>
                     <div class="form-group">
                        <label for="emergency_city">住所(市区町村)</label>
                        <input type="text" id="emergency_city" name="emergency_city" placeholder="例: 千代田区皇居外苑">
                    </div>
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="emergency_address_line1">住所(丁目・番地)</label>
                        <input type="text" id="emergency_address_line1" name="emergency_address_line1" placeholder="例: 1-2">
                    </div>
                    <div class="form-group">
                        <label for="emergency_address_line2">住所(建物名・部屋番号)</label>
                        <input type="text" id="emergency_address_line2" name="emergency_address_line2" placeholder="例: パレスビル202号室">
                    </div>
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="emergency_phone">(電話番号)</label>
                        <input type="tel" id="emergency_phone" name="emergency_phone" placeholder="例: 090-1111-2222">
                        <p class="description">半角入力 (例)090-1111-2222</p>
                    </div>
                    <div class="form-group">
                        <label for="emergency_relationship">(続柄)</label>
                        <select id="emergency_relationship" name="emergency_relationship">
                            <option value="">選択してください</option>
                            <option value="parent">親</option>
                            <option value="spouse">配偶者</option>
                            <option value="child">子</option>
                            <option value="sibling">兄弟姉妹</option>
                            <option value="other_relative">その他親族</option>
                            <option value="friend">友人</option>
                            <option value="other">その他</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <!-- 給与支払口座 -->
            <fieldset class="form-section">
                <legend><h2>給与支払口座</h2></legend>

                <div class="form-group">
                    <label for="bank_account_file_input">通帳またはキャッシュカード (1)</label>
                    <div class="file-upload-area" id="file-drop-area">
                        <input type="file" id="bank_account_file_input" name="bank_book_image" accept="image/*,.pdf">
                        <p>ファイルをドロップして添付 または <span class="browse-link">閲覧</span></p>
                    </div>
                    <div id="file-info"></div>
                    <p class="description">ご本人名義のもの。口座番号等情報と氏名が表裏で表記のある場合は、両面アップロードをお願いいたします。</p>
                </div>

                <div class="form-group">
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="bank_type" value="general" checked onchange="toggleBankAccountForm()">
                            銀行
                        </label>
                        <label>
                            <input type="radio" name="bank_type" value="jp" onchange="toggleBankAccountForm()">
                            ゆうちょ銀行
                        </label>
                    </div>
                </div>

                <!-- 一般銀行用フォーム -->
                <div id="general-bank-form">
                    <div class="inline-fields">
                        <div class="form-group">
                            <label for="general_bank_name">銀行名</label>
                            <input type="text" id="general_bank_name" name="general_bank_name" autocomplete="off" placeholder="例: 三菱UFJ銀行">
                            <div class="suggestion-box" id="bank_name_suggestions"></div>
                        </div>
                        <div class="form-group">
                            <label for="general_branch_name">支店名</label>
                            <input type="text" id="general_branch_name" name="general_branch_name" autocomplete="off" placeholder="例: 渋谷支店">
                            <div class="suggestion-box" id="branch_name_suggestions"></div>
                        </div>
                         <div class="form-group">
                            <label for="general_branch_code">支店コード</label>
                            <input type="text" id="general_branch_code" name="general_branch_code" placeholder="例: 001" readonly class="readonly-field">
                        </div>
                    </div>
                    <div class="inline-fields">
                         <div class="form-group">
                            <label for="general_account_type">預金種別</label>
                             <select id="general_account_type" name="general_account_type">
                                <option value="ordinary" selected>普通</option>
                                <option value="checking">当座</option>
                                <option value="savings">貯蓄</option>
                             </select>
                        </div>
                        <div class="form-group">
                            <label for="general_account_number">口座番号</label>
                            <input type="text" id="general_account_number" name="general_account_number" placeholder="例: 1234567" maxlength="7">
                        </div>
                        <div class="form-group">
                            <label for="general_account_holder_name">名義(カタカナ)</label>
                            <input type="text" id="general_account_holder_name" name="general_account_holder_name" placeholder="例: ヤマダ タロウ">
                        </div>
                    </div>
                </div>

                <!-- ゆうちょ銀行用フォーム -->
                <div id="jp-bank-form" style="display: none;">
                    <div class="form-group">
                        <label for="jp_bank_name">銀行名</label>
                        <input type="text" id="jp_bank_name" name="jp_bank_name" value="ゆうちょ銀行" readonly class="readonly-field">
                    </div>
                    
                    <div class="form-group">
                        <label>口座の記号・番号を入力</label>
                        <div class="jp-bank-account-number-fields">
                            <div class="form-group">
                                <label for="jp_kigo_1" style="font-weight:normal;">記号 (半角)</label>
                                <input type="tel" id="jp_kigo_1" name="jp_kigo_1" maxlength="5" placeholder="例: 12345">
                            </div>
                            <span>-</span>
                            <div class="form-group">
                                <label for="jp_kigo_2" style="font-weight:normal;">&nbsp;</label>
                                <input type="tel" id="jp_kigo_2" name="jp_kigo_2" maxlength="1" placeholder="例: 1">
                            </div>
                            <span>-</span>
                            <div class="form-group">
                                <label for="jp_bango" style="font-weight:normal;">番号 (半角)</label>
                                <input type="tel" id="jp_bango" name="jp_bango" maxlength="8" placeholder="例: 12345678">
                            </div>
                        </div>
                         <p class="description">※記号と番号の間に1桁の数字がない場合は、真ん中の入力欄は空欄にしてください。</p>
                    </div>

                     <div class="inline-fields">
                        <div class="form-group">
                            <label for="jp_account_type">預金種別</label>
                            <select id="jp_account_type" name="jp_account_type">
                                <option value="ordinary" selected>普通</option>
                                <option value="savings">貯蓄</option>
                                <option value="checking">当座</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label for="jp_account_holder_name">名義(カタカナ)</label>
                            <input type="text" id="jp_account_holder_name" name="jp_account_holder_name" placeholder="例：ヤマダ タロウ">
                        </div>
                    </div>

                    <div class="inline-fields">
                        <div class="form-group">
                            <label for="jp_branch_name">店名</label>
                            <input type="text" id="jp_branch_name" name="jp_branch_name" placeholder="自動入力" readonly class="readonly-field">
                        </div>
                        <div class="form-group">
                            <label for="jp_branch_code">店番</label>
                            <input type="tel" id="jp_branch_code" name="jp_branch_code" placeholder="自動入力" readonly class="readonly-field">
                        </div>
                    </div>
                </div>

            </fieldset>

            <div class="navigation-buttons">
                <span></span> <!-- Prev button placeholder -->
                <a href="フロー2_社保加入申請.html" class="action-button-style next-btn" id="saveAndNext">次へ（フロー2_社保加入申請）</a>
            </div>
        </form>
    </div>

    <!-- (入社)雇用契約書 兼 雇入通知書 モーダル -->
    <div id="employmentContractModal" class="modal contract-agreement-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="employmentContractModalTitle">労働条件通知書 兼 雇用契約書</h3>
                <span class="close-button" data-modal-id="employmentContractModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="contract-viewer">
                    <img src="contract_pending_signature.png" alt="雇用契約書" id="employmentContract_image">
                </div>
                
                <div id="employmentContract_pre_agreement_content">
                    <p class="action-prompt">書類を確認のうえ、「合意に進む」を押してください。</p>
                    <div class="button-group">
                        <button type="button" class="action-btn reject-btn" data-contract-id="employmentContract">差し戻す</button>
                        <button type="button" class="action-btn agree-btn" data-contract-id="employmentContract">合意に進む</button>
                    </div>
                    <form id="employmentContract_agree_form" style="display:none;">
                         <div class="form-group">
                            <label for="employmentContract_signer_name">署名<span class="required-label">必須</span></label>
                            <input type="text" id="employmentContract_signer_name" name="signer_name" placeholder="例: 鈴木 一郎">
                            <span class="error-message" id="employmentContract_signer_name_error"></span>
                        </div>
                        <div class="form-group">
                            <label>書類の受け取り方法<span class="required-label">必須</span></label>
                            <div class="checkbox-group agree-modal-body"> 
                                <input type="checkbox" id="employmentContract_agree_electronic_delivery" name="agree_electronic_delivery" checked>
                                <label for="employmentContract_agree_electronic_delivery">電子通知で受け取ることに同意する</label>
                            </div>
                            <span class="error-message" id="employmentContract_agree_delivery_error"></span>
                        </div>
                    </form>
                     <form id="employmentContract_reject_form" style="display:none;">
                        <div class="form-group">
                            <label for="employmentContract_reject_reason">差し戻し理由<span class="required-label">必須</span></label>
                            <textarea id="employmentContract_reject_reason" name="reject_reason" placeholder="差し戻しの理由を入力します"></textarea>
                            <span class="error-message" id="employmentContract_reject_reason_error"></span>
                        </div>
                    </form>
                </div>

                <div class="post-agreement-actions-modal" id="employmentContract_post_agreement_content">
                    <p class="action-prompt" style="color:green; font-weight:bold;">この書類は合意済みです。</p>
                    <div class="action-buttons-row-inner">
                        <button type="button" class="action-btn-small print-contract-btn">
                            <svg viewBox="0 0 20 20"><path d="M16 10c0 .55-.45 1-1 1H5c-.55 0-1-.45-1-1s.45-1 1-1h10c.55 0 1 .45 1 1zM5 13h4c.55 0 1 .45 1 1s-.45 1-1 1H5c-.55 0-1-.45-1-1s.45-1 1-1zm12-8H3c-.55 0-1 .45-1 1v2H1c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1h18c.55 0 1-.45 1-1V6c0-.55-.45-1-1-1zm-1 10H2V7h1V4h14v9zM6 2h8v2H6V2z"/></svg>
                            印刷
                        </button>
                        <button type="button" class="action-btn-small download-contract-btn">
                            <svg viewBox="0 0 20 20"><path d="M13 8V2H7v6H2l8 8 8-8h-5zM0 18h20v2H0v-2z"/></svg>
                            ダウンロード
                        </button>
                    </div>
                    <span class="checkbox-option">
                        <input type="checkbox" id="employmentContract_show_agreement_mark" checked>
                        <label for="employmentContract_show_agreement_mark">合意マークを表示する</label>
                    </span>
                </div>
            </div>
            <div class="modal-footer" id="employmentContract_modal_footer">
                <!-- JSでボタンを動的に設定 -->
            </div>
        </div>
    </div>

    <!-- 契約書 兼 身元保証書 モーダル -->
    <div id="guaranteeContractModal" class="modal contract-agreement-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="guaranteeContractModalTitle">契約書 兼 身元保証書</h3>
                <span class="close-button" data-modal-id="guaranteeContractModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="contract-viewer">
                    <img src="pledge-before-agreement.png" alt="身元保証書" id="guaranteeContract_image">
                </div>

                <div id="guaranteeContract_pre_agreement_content">
                    <p class="action-prompt">書類を確認のうえ、「合意に進む」を押してください。</p>
                    <div class="button-group">
                        <button type="button" class="action-btn reject-btn" data-contract-id="guaranteeContract">差し戻す</button>
                        <button type="button" class="action-btn agree-btn" data-contract-id="guaranteeContract">合意に進む</button>
                    </div>
                     <form id="guaranteeContract_agree_form" style="display:none;">
                         <div class="form-group">
                            <label for="guaranteeContract_signer_name">署名<span class="required-label">必須</span></label>
                            <input type="text" id="guaranteeContract_signer_name" name="signer_name" placeholder="例: 佐藤 花子">
                            <span class="error-message" id="guaranteeContract_signer_name_error"></span>
                        </div>
                        <div class="form-group">
                            <label>書類の受け取り方法<span class="required-label">必須</span></label>
                            <div class="checkbox-group agree-modal-body">
                                <input type="checkbox" id="guaranteeContract_agree_electronic_delivery" name="agree_electronic_delivery" checked>
                                <label for="guaranteeContract_agree_electronic_delivery">電子通知で受け取ることに同意する</label>
                            </div>
                             <span class="error-message" id="guaranteeContract_agree_delivery_error"></span>
                        </div>
                    </form>
                    <form id="guaranteeContract_reject_form" style="display:none;">
                        <div class="form-group">
                            <label for="guaranteeContract_reject_reason">差し戻し理由<span class="required-label">必須</span></label>
                            <textarea id="guaranteeContract_reject_reason" name="reject_reason" placeholder="差し戻しの理由を入力します"></textarea>
                            <span class="error-message" id="guaranteeContract_reject_reason_error"></span>
                        </div>
                    </form>
                </div>
                <div class="post-agreement-actions-modal" id="guaranteeContract_post_agreement_content">
                     <p class="action-prompt" style="color:green; font-weight:bold;">この書類は合意済みです。</p>
                    <div class="action-buttons-row-inner">
                        <button type="button" class="action-btn-small print-contract-btn">
                            <svg viewBox="0 0 20 20"><path d="M16 10c0 .55-.45 1-1 1H5c-.55 0-1-.45-1-1s.45-1 1-1h10c.55 0 1 .45 1 1zM5 13h4c.55 0 1 .45 1 1s-.45 1-1 1H5c-.55 0-1-.45-1-1s.45-1 1-1zm12-8H3c-.55 0-1 .45-1 1v2H1c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1h18c.55 0 1-.45 1-1V6c0-.55-.45-1-1-1zm-1 10H2V7h1V4h14v9zM6 2h8v2H6V2z"/></svg>
                            印刷
                        </button>
                        <button type="button" class="action-btn-small download-contract-btn">
                            <svg viewBox="0 0 20 20"><path d="M13 8V2H7v6H2l8 8 8-8h-5zM0 18h20v2H0v-2z"/></svg>
                            ダウンロード
                        </button>
                    </div>
                    <span class="checkbox-option">
                        <input type="checkbox" id="guaranteeContract_show_agreement_mark" checked>
                        <label for="guaranteeContract_show_agreement_mark">合意マークを表示する</label>
                    </span>
                </div>
            </div>
            <div class="modal-footer" id="guaranteeContract_modal_footer">
                <!-- JSでボタンを動的に設定 -->
            </div>
        </div>
    </div>

    <script>
        // --- START: 給与支払口座フォーム切り替え機能 ---
        function toggleBankAccountForm() {
            const isJpBank = document.querySelector('input[name="bank_type"][value="jp"]').checked;
            const generalForm = document.getElementById('general-bank-form');
            const jpBankForm = document.getElementById('jp-bank-form');
            
            const generalInputs = generalForm.querySelectorAll('input, select');
            const jpInputs = jpBankForm.querySelectorAll('input, select');

            if (isJpBank) {
                jpBankForm.style.display = 'block';
                generalForm.style.display = 'none';
                jpInputs.forEach(input => input.disabled = false);
                generalInputs.forEach(input => input.disabled = true);
            } else {
                generalForm.style.display = 'block';
                jpBankForm.style.display = 'none';
                generalInputs.forEach(input => input.disabled = false);
                jpInputs.forEach(input => input.disabled = true);
            }
        }
        // --- END: 給与支払口座フォーム切り替え機能 ---

        document.addEventListener('DOMContentLoaded', function () {
            // --- START: Basic Info, Nationality, File Upload (partial) ---
            const nationalityRadios = document.querySelectorAll('input[name="nationality"]');
            const residenceStatusGroup = document.getElementById('residence_status_group');
            const foreignDocumentsContainer = document.getElementById('foreign_documents_container');

            function updateFileStatusDisplay(fileInput, statusElement, deleteButton) {
                if (fileInput.files && fileInput.files.length > 0) {
                    statusElement.textContent = fileInput.files[0].name;
                    if (deleteButton) deleteButton.style.display = 'inline-block';
                    localStorage.setItem(fileInput.id + '_filename', fileInput.files[0].name);
                } else {
                    statusElement.textContent = statusElement.dataset.initialText || "選択されていません";
                    if (deleteButton) deleteButton.style.display = 'none';
                    localStorage.removeItem(fileInput.id + '_filename');
                }
            }
            
            function createForeignerDocumentUploadBox(id, name, labelText, icon = '📄') {
                const docBox = document.createElement('div');
                docBox.className = 'document-box';
                docBox.id = `${id}_doc_box`;
                docBox.style.flexBasis = 'calc(50% - 5px)'; // For two columns
                const docIcon = document.createElement('span');
                docIcon.className = 'document-icon';
                docIcon.textContent = icon;
                docBox.appendChild(docIcon);
                const pLabel = document.createElement('p');
                const strongLabel = document.createElement('strong');
                strongLabel.textContent = labelText;
                pLabel.appendChild(strongLabel);
                docBox.appendChild(pLabel);
                
                const fileInput = document.createElement('input');
                fileInput.type = 'file'; fileInput.id = id; fileInput.name = name; fileInput.style.display = 'none'; fileInput.accept = 'image/*,.pdf';
                docBox.appendChild(fileInput);

                const uploadLabel = document.createElement('label');
                uploadLabel.htmlFor = id; uploadLabel.className = 'upload-button-placeholder'; uploadLabel.textContent = 'アップロード';
                uploadLabel.style.marginTop = '5px'; uploadLabel.style.display = 'inline-block';
                docBox.appendChild(uploadLabel);
                
                const statusContainer = document.createElement('div');
                statusContainer.className = 'file-upload-status-container';

                const pStatus = document.createElement('span');
                pStatus.className = 'file-status'; pStatus.id = `${id}_file_status`; pStatus.textContent = '選択されていません';
                pStatus.dataset.initialText = '選択されていません';
                statusContainer.appendChild(pStatus);

                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'delete-file-btn';
                deleteBtn.textContent = '削除';
                deleteBtn.dataset.targetId = id;
                deleteBtn.style.display = 'none';
                statusContainer.appendChild(deleteBtn);
                docBox.appendChild(statusContainer);

                const storedFilename = localStorage.getItem(id + '_filename');
                if (storedFilename) {
                    pStatus.textContent = storedFilename;
                    deleteBtn.style.display = 'inline-block';
                    uploadLabel.textContent = '変更';
                }

                fileInput.addEventListener('change', function() {
                    updateFileStatusDisplay(this, pStatus, deleteBtn); // Uses the global helper
                     if (this.files && this.files.length > 0) {
                        uploadLabel.textContent = '変更';
                    } else {
                        uploadLabel.textContent = 'アップロード';
                    }
                });
                deleteBtn.addEventListener('click', function() {
                    fileInput.value = ''; 
                    updateFileStatusDisplay(fileInput, pStatus, deleteBtn); // Uses the global helper
                    uploadLabel.textContent = 'アップロード';
                });
                return docBox;
            }

            if (residenceStatusGroup && foreignDocumentsContainer) {
                nationalityRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.value === 'foreign') {
                            residenceStatusGroup.style.display = 'block';
                            foreignDocumentsContainer.style.display = 'flex';
                            if (foreignDocumentsContainer.children.length === 0) { // Add only if not already added
                                foreignDocumentsContainer.appendChild(createForeignerDocumentUploadBox('residence_card_image', 'residence_card_image', '在留カード', '💳'));
                                foreignDocumentsContainer.appendChild(createForeignerDocumentUploadBox('passport_image', 'passport_image', 'パスポート', '🛂'));
                            }
                        } else {
                            residenceStatusGroup.style.display = 'none';
                            foreignDocumentsContainer.style.display = 'none';
                        }
                    });
                });
                const checkedNationality = document.querySelector('input[name="nationality"]:checked');
                if (checkedNationality) {
                    checkedNationality.dispatchEvent(new Event('change'));
                }
            }
            // --- END: Basic Info, Nationality, File Upload (partial) ---


            // --- START: Contract Document Modal Logic ---
            const contractDocumentBoxes = document.querySelectorAll('.clickable-document');
            const allModals = document.querySelectorAll('.modal');

            function openModal(modalElement) { modalElement.style.display = 'flex'; }
            function closeModal(modalElement) {
                modalElement.style.display = 'none';
                if (modalElement.classList.contains('contract-agreement-modal')) {
                    const contractId = modalElement.id.replace('Modal', '');
                    if (localStorage.getItem(`${contractId}_status`) !== 'agreed') {
                         resetContractModalForms(modalElement, contractId);
                    }
                }
            }
            function resetContractModalForms(modalElement, contractId) {
                const agreeForm = modalElement.querySelector(`#${contractId}_agree_form`);
                if (agreeForm) agreeForm.style.display = 'none';
                const rejectForm = modalElement.querySelector(`#${contractId}_reject_form`);
                if (rejectForm) rejectForm.style.display = 'none';
                
                ['signer_name', 'reject_reason'].forEach(field => {
                    const input = modalElement.querySelector(`#${contractId}_${field}`);
                    if (input) { input.value = ''; input.classList.remove('input-error'); }
                    const errorMsg = modalElement.querySelector(`#${contractId}_${field}_error`);
                    if (errorMsg) errorMsg.textContent = '';
                });
                const deliveryError = modalElement.querySelector(`#${contractId}_agree_delivery_error`);
                if (deliveryError) deliveryError.textContent = '';
                const deliveryCheckbox = modalElement.querySelector(`#${contractId}_agree_electronic_delivery`);
                if(deliveryCheckbox) deliveryCheckbox.checked = true;

                const preAgreementContent = modalElement.querySelector(`#${contractId}_pre_agreement_content`);
                if(preAgreementContent) {
                    const buttonGroup = preAgreementContent.querySelector('.button-group');
                    if(buttonGroup) buttonGroup.style.display = 'flex';
                }
                updateModalFooter(modalElement, contractId, 'initial');
            }

            contractDocumentBoxes.forEach(box => {
                box.addEventListener('click', function() {
                    const modalId = this.dataset.modalTarget;
                    const contractId = this.dataset.contractId;
                    const modalElement = document.querySelector(modalId);
                    if (modalElement) { 
                        loadContractModalState(modalElement, contractId);
                        openModal(modalElement); 
                    }
                });
            });

            document.querySelectorAll('.modal .close-button').forEach(button => {
                button.addEventListener('click', function() { closeModal(this.closest('.modal')); });
            });

            window.addEventListener('click', function(event) {
                allModals.forEach(modal => { if (event.target === modal) { closeModal(modal); } });
            });

            function loadContractModalState(modalElement, contractId) {
                const contractStatus = localStorage.getItem(`${contractId}_status`) || 'pending';
                const contractImageElement = modalElement.querySelector(`#${contractId}_image`);
                const preAgreementContent = modalElement.querySelector(`#${contractId}_pre_agreement_content`);
                const postAgreementContent = modalElement.querySelector(`#${contractId}_post_agreement_content`);
                
                const agreeForm = modalElement.querySelector(`#${contractId}_agree_form`);
                const rejectForm = modalElement.querySelector(`#${contractId}_reject_form`);
                const buttonGroup = preAgreementContent.querySelector('.button-group');

                if(agreeForm) agreeForm.style.display = 'none';
                if(rejectForm) rejectForm.style.display = 'none';
                if(buttonGroup) buttonGroup.style.display = 'flex';

                let imgSrc = '';
                if (contractId === 'employmentContract') {
                    imgSrc = (contractStatus === 'agreed') ? 'contract_signed.png' : 'contract_pending_signature.png';
                } else if (contractId === 'guaranteeContract') {
                    imgSrc = (contractStatus === 'agreed') ? 'pledge-after-agreement.png' : 'pledge-before-agreement.png';
                }
                contractImageElement.src = imgSrc;


                if (contractStatus === 'agreed') {
                    preAgreementContent.style.display = 'none';
                    postAgreementContent.style.display = 'flex';
                    updateModalFooter(modalElement, contractId, 'agreed');
                } else {
                    preAgreementContent.style.display = 'block'; 
                    postAgreementContent.style.display = 'none';
                    updateModalFooter(modalElement, contractId, 'initial'); 
                }
            }

            function updateModalFooter(modalElement, contractId, state) {
                const footer = modalElement.querySelector(`#${contractId}_modal_footer`);
                footer.innerHTML = '';

                if (state === 'agree_form') {
                    footer.innerHTML = `<button type="button" class="action-btn btn-secondary" data-action="cancel_agree" data-contract-id="${contractId}">キャンセル</button><button type="button" class="action-btn agree-btn" data-action="submit_agree" data-contract-id="${contractId}">合意する</button>`;
                } else if (state === 'reject_form') {
                     footer.innerHTML = `<button type="button" class="action-btn btn-secondary" data-action="cancel_reject" data-contract-id="${contractId}">キャンセル</button><button type="button" class="action-btn reject-btn submit" data-action="submit_reject" data-contract-id="${contractId}">差し戻す</button>`;
                } else if (state === 'agreed') {
                    footer.innerHTML = `<button type="button" class="action-btn btn-secondary" data-action="close" data-contract-id="${contractId}">閉じる</button>`;
                } else {
                     footer.innerHTML = `<button type="button" class="action-btn btn-secondary" data-action="close" data-contract-id="${contractId}">閉じる</button>`;
                }
                footer.querySelectorAll('button').forEach(btn => { btn.addEventListener('click', handleModalFooterAction); });
            }

            function handleModalFooterAction(event) {
                const action = event.target.dataset.action;
                const contractId = event.target.dataset.contractId;
                const modalElement = document.getElementById(`${contractId}Modal`);
                
                const agreeForm = modalElement.querySelector(`#${contractId}_agree_form`);
                const rejectForm = modalElement.querySelector(`#${contractId}_reject_form`);
                const buttonGroup = modalElement.querySelector(`#${contractId}_pre_agreement_content .button-group`);

                if (action === 'cancel_agree' || action === 'cancel_reject') {
                    if(agreeForm) agreeForm.style.display = 'none';
                    if(rejectForm) rejectForm.style.display = 'none';
                    if(buttonGroup) buttonGroup.style.display = 'flex';
                    updateModalFooter(modalElement, contractId, 'initial');
                } else if (action === 'submit_agree') { submitAgreement(modalElement, contractId);
                } else if (action === 'submit_reject') { submitRejection(modalElement, contractId);
                } else if (action === 'close') { closeModal(modalElement); }
            }

            modalEventListeners('add'); 

            function modalEventListeners(actionType) {
                 document.querySelectorAll('.contract-agreement-modal .agree-btn, .contract-agreement-modal .reject-btn').forEach(button => {
                    if (button.closest && button.closest(`#${button.dataset.contractId}_pre_agreement_content`)) {
                        const handler = (event) => handlePreAgreementActions(event, button.classList.contains('agree-btn') ? 'agree' : 'reject');
                        if (actionType === 'add') {
                            button.removeEventListener('click', handler);
                            button.addEventListener('click', handler);
                        } else {
                            button.removeEventListener('click', handler);
                        }
                    }
                });
            }
            
            function handlePreAgreementActions(event, type) {
                const contractId = event.target.dataset.contractId;
                const modalElement = document.getElementById(`${contractId}Modal`);
                const agreeForm = modalElement.querySelector(`#${contractId}_agree_form`);
                const rejectForm = modalElement.querySelector(`#${contractId}_reject_form`);
                const buttonGroup = modalElement.querySelector(`#${contractId}_pre_agreement_content .button-group`);
                
                buttonGroup.style.display = 'none';

                if (type === 'agree') {
                    agreeForm.style.display = 'block'; rejectForm.style.display = 'none';
                    updateModalFooter(modalElement, contractId, 'agree_form');
                } else if (type === 'reject') {
                    rejectForm.style.display = 'block'; agreeForm.style.display = 'none';
                    updateModalFooter(modalElement, contractId, 'reject_form');
                }
            }

            function submitAgreement(modalElement, contractId) {
                const signerNameInput = modalElement.querySelector(`#${contractId}_signer_name`);
                const deliveryCheckbox = modalElement.querySelector(`#${contractId}_agree_electronic_delivery`);
                const signerError = modalElement.querySelector(`#${contractId}_signer_name_error`);
                const deliveryError = modalElement.querySelector(`#${contractId}_agree_delivery_error`);
                let isValid = true;

                signerError.textContent = ''; deliveryError.textContent = ''; signerNameInput.classList.remove('input-error');

                if (signerNameInput.value.trim() === '') {
                    signerError.textContent = '氏名を入力してください。'; signerNameInput.classList.add('input-error'); isValid = false;
                }
                if (!deliveryCheckbox.checked) {
                    deliveryError.textContent = '電子通知での受け取りに同意してください。'; isValid = false;
                }

                if (isValid) {
                    localStorage.setItem(`${contractId}_status`, 'agreed');
                    localStorage.setItem(`${contractId}_signer_name`, signerNameInput.value.trim());
                    const mainDocStatus = document.getElementById(`${contractId}Status`);
                    mainDocStatus.textContent = '（合意済）'; mainDocStatus.className = 'contract-status status-agreed';
                    document.getElementById(`${contractId}PostActions`).style.display = 'flex';

                    alert(`${modalElement.querySelector('h3').textContent} に合意しました。`);
                    loadContractModalState(modalElement, contractId);
                }
            }

            function submitRejection(modalElement, contractId) {
                const rejectReasonInput = modalElement.querySelector(`#${contractId}_reject_reason`);
                const reasonError = modalElement.querySelector(`#${contractId}_reject_reason_error`);
                let isValid = true;
                reasonError.textContent = ''; rejectReasonInput.classList.remove('input-error');

                if (rejectReasonInput.value.trim() === '') {
                    reasonError.textContent = '差し戻し理由を入力してください。'; rejectReasonInput.classList.add('input-error'); isValid = false;
                }

                if (isValid) {
                    localStorage.setItem(`${contractId}_status`, 'rejected');
                    localStorage.setItem(`${contractId}_reject_reason`, rejectReasonInput.value.trim());
                    const mainDocStatus = document.getElementById(`${contractId}Status`);
                    mainDocStatus.textContent = '（差戻済）'; mainDocStatus.className = 'contract-status status-rejected';
                    document.getElementById(`${contractId}PostActions`).style.display = 'none';
                    
                    alert(`${modalElement.querySelector('h3').textContent} を差し戻しました。`);
                    closeModal(modalElement);
                }
            }

            contractDocumentBoxes.forEach(box => {
                const contractId = box.dataset.contractId;
                const status = localStorage.getItem(`${contractId}_status`);
                const mainDocStatus = document.getElementById(`${contractId}Status`);
                const postActions = document.getElementById(`${contractId}PostActions`);

                if (status === 'agreed') {
                    mainDocStatus.textContent = '（合意済）'; mainDocStatus.className = 'contract-status status-agreed'; postActions.style.display = 'flex';
                } else if (status === 'rejected') {
                    mainDocStatus.textContent = '（差戻済）'; mainDocStatus.className = 'contract-status status-rejected'; postActions.style.display = 'none';
                } else {
                    mainDocStatus.textContent = '（未合意）'; mainDocStatus.className = 'contract-status status-pending'; postActions.style.display = 'none';
                }
            });

            document.querySelectorAll('.print-contract-btn').forEach(btn => {
                btn.addEventListener('click', () => alert('印刷処理を実行します。（ダミー）'));
            });
            document.querySelectorAll('.download-contract-btn').forEach(btn => {
                btn.addEventListener('click', () => alert('ダウンロード処理を実行します。（ダミー）'));
            });
            document.querySelectorAll('.post-agreement-actions-modal input[type="checkbox"]').forEach(cb => {
                 cb.addEventListener('change', function() { alert(this.checked ? '合意マークを表示します。（ダミー）' : '合意マークを非表示にします。（ダミー）'); });
            });
            ['signer_name', 'reject_reason'].forEach(fieldPrefix => {
                ['employmentContract', 'guaranteeContract'].forEach(contractId => {
                    const input = document.getElementById(`${contractId}_${fieldPrefix}`);
                    const errorSpan = document.getElementById(`${contractId}_${fieldPrefix}_error`);
                    if (input && errorSpan) {
                        input.addEventListener('input', function() { if (this.classList.contains('input-error')) { this.classList.remove('input-error'); errorSpan.textContent = ''; } });
                    }
                });
            });
             ['employmentContract', 'guaranteeContract'].forEach(contractId => {
                const checkbox = document.getElementById(`${contractId}_agree_electronic_delivery`);
                const errorSpan = document.getElementById(`${contractId}_agree_delivery_error`);
                if(checkbox && errorSpan){ checkbox.addEventListener('change', function(){ if(this.checked) errorSpan.textContent = ''; }); }
            });
            // --- END: Contract Document Modal Logic ---


            // --- START: Postal Code Auto-Address and Formatting Logic ---
            function formatPostalCode(inputElement) {
                let value = inputElement.value.replace(/[^0-9]/g, ""); 
                if (value.length > 3) { value = value.substring(0, 3) + "-" + value.substring(3); }
                if (value.length > 8) { value = value.substring(0, 8); }
                inputElement.value = value;
            }
            async function fetchAddressFromPostalCode(postalCode, prefix) {
                const pc = postalCode.replace(/-/g, ''); 
                if (pc.length !== 7) { alert('有効な郵便番号を7桁で入力してください。'); return; }
                try {
                    const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${pc}`);
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                    const data = await response.json();
                    if (data.status === 200 && data.results) {
                        const result = data.results[0];
                        document.getElementById(`${prefix}prefecture`).value = result.address1 || '';
                        document.getElementById(`${prefix}city`).value = result.address2 || '';
                        document.getElementById(`${prefix}address_line1`).value = result.address3 || '';
                    } else { alert(`住所が見つかりませんでした: ${data.message || ''}`); }
                } catch (error) { console.error('住所検索エラー:', error); alert('住所の検索中にエラーが発生しました。'); }
            }
            const postalCodeInput = document.getElementById('postal_code');
            const searchAddressBtn = document.getElementById('search_address_btn');
            const emergencyPostalCodeInput = document.getElementById('emergency_postal_code');
            const searchEmergencyAddressBtn = document.getElementById('search_emergency_address_btn');

            if (postalCodeInput) { postalCodeInput.addEventListener('input', () => formatPostalCode(postalCodeInput)); postalCodeInput.addEventListener('blur', () => formatPostalCode(postalCodeInput)); }
            if (searchAddressBtn && postalCodeInput) { searchAddressBtn.addEventListener('click', () => fetchAddressFromPostalCode(postalCodeInput.value, '')); }
            
            if (emergencyPostalCodeInput) { emergencyPostalCodeInput.addEventListener('input', () => formatPostalCode(emergencyPostalCodeInput)); emergencyPostalCodeInput.addEventListener('blur', () => formatPostalCode(emergencyPostalCodeInput));}
            if (searchEmergencyAddressBtn && emergencyPostalCodeInput) { searchEmergencyAddressBtn.addEventListener('click', () => fetchAddressFromPostalCode(emergencyPostalCodeInput.value, 'emergency_')); }
            // --- END: Postal Code Auto-Address and Formatting Logic ---


            // --- START: Bank Info (New Integrated Logic) ---
            toggleBankAccountForm();

            const dropArea = document.getElementById('file-drop-area');
            const bankAccountFileInput = document.getElementById('bank_account_file_input');
            const fileInfoContainer = document.getElementById('file-info');

            if(dropArea) {
                dropArea.addEventListener('click', () => bankAccountFileInput.click());
                dropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropArea.classList.add('dragover');
                });
                dropArea.addEventListener('dragleave', () => {
                    dropArea.classList.remove('dragover');
                });
                dropArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        bankAccountFileInput.files = files;
                        handleBankAccountFiles(files);
                    }
                });
            }
            if(bankAccountFileInput) {
                bankAccountFileInput.addEventListener('change', () => {
                    handleBankAccountFiles(bankAccountFileInput.files);
                });
            }

            function handleBankAccountFiles(files) {
                fileInfoContainer.innerHTML = '';
                if (files.length === 0) return;
                
                fileInfoContainer.innerHTML = `
                    <div class="file-info-header">
                        <span class="file-name">ファイル名</span>
                        <span class="file-size">サイズ</span>
                    </div>
                `;
                const file = files[0];
                const fileSize = (file.size / 1024).toFixed(2) + ' KB';
                
                const fileRow = document.createElement('div');
                fileRow.className = 'file-info-row';
                fileRow.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${fileSize}</span>
                `;
                fileInfoContainer.appendChild(fileRow);
            }

            const bankNameInput = document.getElementById('general_bank_name');
            const bankNameSuggestionsBox = document.getElementById('bank_name_suggestions');
            const branchNameInput = document.getElementById('general_branch_name');
            const branchNameSuggestionsBox = document.getElementById('branch_name_suggestions');
            const branchCodeInput = document.getElementById('general_branch_code');

            const dummyBanks = [
                { name: "三菱UFJ銀行", code: "0005", branches: [{name: "本店", code: "001"}, {name: "渋谷支店", code: "135"}, {name: "新宿支店", code: "300"}, {name: "オンライン支店", code: "777"}] },
                { name: "三井住友銀行", code: "0009", branches: [{name: "本店営業部", code: "600"}, {name: "池袋支店", code: "261"}, {name: "神戸営業部", code: "400"}] },
                { name: "みずほ銀行", code: "0001", branches: [{name: "丸之内支店", code: "002"}, {name: "銀座支店", code: "020"}, {name: "インターネット支店", code: "686"}] },
                { name: "ゆうちょ銀行", code: "9900", branches: [{name: "本店", code: "019"}, {name: "〇一八支店", code: "018"}, {name: "二一八支店", code: "218"}] },
                { name: "楽天銀行", code: "0036", branches: [{name: "ジャズ支店", code: "201"}, {name: "ロック支店", code: "202"}, {name: "サンバ支店", code: "203"}] }
            ];

            function showSuggestions(inputElement, suggestionBox, items, itemKey = 'name') {
                suggestionBox.innerHTML = '';
                if (items.length > 0) {
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.textContent = item[itemKey];
                        div.addEventListener('click', () => {
                            inputElement.value = item[itemKey];
                            suggestionBox.style.display = 'none';
                            suggestionBox.innerHTML = '';
                            
                            if (inputElement.id === 'general_bank_name') {
                                branchNameInput.value = '';
                                branchCodeInput.value = '';
                                branchNameInput.focus();
                            } else if (inputElement.id === 'general_branch_name') {
                                branchCodeInput.value = item.code || 'XXX';
                            }
                        });
                        suggestionBox.appendChild(div);
                    });
                    suggestionBox.style.display = 'block';
                } else {
                    suggestionBox.style.display = 'none';
                }
            }
            
            if (bankNameInput && bankNameSuggestionsBox) {
                bankNameInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase();
                    const filteredBanks = dummyBanks.filter(bank => bank.name.toLowerCase().includes(query) && bank.code !== '9900');
                    showSuggestions(this, bankNameSuggestionsBox, filteredBanks, 'name');
                });
                bankNameInput.addEventListener('blur', function() { 
                    setTimeout(() => { if (!bankNameSuggestionsBox.contains(document.activeElement)) bankNameSuggestionsBox.style.display = 'none'; }, 150);
                });
            }

            if (branchNameInput && branchNameSuggestionsBox && bankNameInput && branchCodeInput) {
                branchNameInput.addEventListener('input', function() {
                    const selectedBankName = bankNameInput.value;
                    const bankData = dummyBanks.find(b => b.name === selectedBankName);
                    if (bankData && bankData.branches) {
                        const query = this.value.toLowerCase();
                        const filteredBranches = bankData.branches.filter(branch => branch.name.toLowerCase().includes(query));
                        showSuggestions(this, branchNameSuggestionsBox, filteredBranches, 'name');
                    } else {
                        branchNameSuggestionsBox.style.display = 'none';
                        branchCodeInput.value = '';
                    }
                });
                 branchNameInput.addEventListener('blur', function() { 
                    setTimeout(() => { if (!branchNameSuggestionsBox.contains(document.activeElement)) branchNameSuggestionsBox.style.display = 'none'; }, 150);
                });
            }
            
            const kigo1Input = document.getElementById('jp_kigo_1');
            const bangoInput = document.getElementById('jp_bango');
            const jpBranchNameInput = document.getElementById('jp_branch_name');
            const jpBranchCodeInput = document.getElementById('jp_branch_code');

            function convertJpAccount() {
                const kigo = kigo1Input.value;
                if (kigo.length < 5) {
                    jpBranchNameInput.value = '';
                    jpBranchCodeInput.value = '';
                    return;
                }

                const lastDigit = kigo.slice(-1);
                let branchCode = '';
                let branchName = '';

                if (lastDigit === '9') {
                    branchCode = kigo.substring(0, 3);
                    const nameMap = {'01': '〇一', '02': '〇二', '11': '一一', '12': '一二'}; // ダミーデータ
                    branchName = (nameMap[branchCode.substring(0,2)] || 'ＸＸ') + '九';
                } else {
                    branchCode = kigo.substring(0, 2) + '8';
                    const tensDigit = kigo.charAt(2);
                    const onesDigit = kigo.charAt(3);
                    const kanjiMap = {'0':'〇', '1':'一', '2':'二', '3':'三', '4':'四', '5':'五', '6':'六', '7':'七', '8':'八', '9':'九'};
                    branchName = kanjiMap[tensDigit] + kanjiMap[onesDigit] + '八';
                }

                jpBranchNameInput.value = `${branchName}（${branchCode}）`;
                jpBranchCodeInput.value = branchCode;
            }

            if (kigo1Input && bangoInput) {
                kigo1Input.addEventListener('input', convertJpAccount);
                bangoInput.addEventListener('input', convertJpAccount);
            }
            // --- END: Bank Info ---
            
            // --- START: Save address to localStorage for page 3 ---
            const saveAndNextButton = document.getElementById('saveAndNext');
            if (saveAndNextButton) {
                saveAndNextButton.addEventListener('click', function() {
                    localStorage.setItem('prefecture', document.getElementById('prefecture').value);
                    localStorage.setItem('city', document.getElementById('city').value);
                    localStorage.setItem('address_line1', document.getElementById('address_line1').value);
                });
            }
            // --- END: Save address to localStorage for page 3 ---

            // --- START: Devtool buttons ---
            const devFillFormBtn = document.getElementById('dev_fill_form_btn');
            const devResetFormBtn = document.getElementById('dev_reset_form_btn');
            const devClearStorageBtn = document.getElementById('dev_clear_storage_btn');

            if(devFillFormBtn) {
                devFillFormBtn.addEventListener('click', () => {
                    document.getElementById('last_name').value = '開発';
                    document.getElementById('first_name').value = '花子';
                    document.getElementById('last_name_kana').value = 'カイハツ';
                    document.getElementById('first_name_kana').value = 'ハナコ';
                    document.getElementById('gender').value = 'female';
                    document.getElementById('birth_date').value = '1995-05-15';
                    document.getElementById('mobile_phone_number').value = '090-9876-5432';
                    document.getElementById('email').value = 'hanako.dev@example.com';
                    document.getElementById('postal_code').value = '150-0002';
                    fetchAddressFromPostalCode('150-0002', '').then(() => {
                        document.getElementById('address_line2').value = 'テストアパート303';
                        document.getElementById('address_kana').value = 'トウキョウトシブヤクシブヤ';
                    });
                    document.getElementById('emergency_last_name').value = '開発';
                    document.getElementById('emergency_first_name').value = '一郎';
                    document.getElementById('emergency_relationship').value = 'sibling';
                    
                    document.querySelector('input[name="bank_type"][value="general"]').click();
                    document.getElementById('general_bank_name').value = '三菱UFJ銀行';
                    document.getElementById('general_branch_name').value = '渋谷支店';
                    document.getElementById('general_branch_code').value = '135';
                    document.getElementById('general_account_number').value = '1234567';
                    document.getElementById('general_account_holder_name').value = 'カイハツ ハナコ';
                    
                    console.log("テストデータがページ1の項目に入力されました。");
                });
            }
            if(devResetFormBtn) {
                 devResetFormBtn.addEventListener('click', () => {
                    document.getElementById('onboardingFormPage1').reset();
                    document.querySelectorAll('.file-status').forEach(el => {
                        el.textContent = el.dataset.initialText || "選択されていません";
                    });
                     if(foreignDocumentsContainer) foreignDocumentsContainer.innerHTML = '';
                     if(fileInfoContainer) fileInfoContainer.innerHTML = '';

                     toggleBankAccountForm();

                    console.log("ページ1のフォーム入力がリセットされました。");
                });
            }
            if(devClearStorageBtn) {
                devClearStorageBtn.addEventListener('click', () => {
                    localStorage.clear();
                    alert('LocalStorageがクリアされました。ページを再読み込みします。');
                    window.location.reload();
                });
            }
            // --- END: Devtool buttons ---
        });
    </script>
</body>
</html>

